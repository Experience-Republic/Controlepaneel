<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="index.css" />
        <script defer type="module" src="index.js"></script>
        <!-- Import the urls from the index.js module. -->
        <script type="module">
            import { urls } from './urls.js'
            // Make them globally available.
            window.urls = urls            
        </script>
    </head>
    <body>
        <div
            x-data="{ image_1:false, image_2:false, image_3:false, image_4:false, show_names: false, show_video: false, countdownTimer : timer(new Date().setSeconds(new Date().getSeconds() + 635)), correct_answers: 0, time_expired: false, open_code_message: false, before_start: true }"
            x-init="document.addEventListener('keydown', function handleKeyDown(event) {
                if (event.code === 'Space') {                  
                  show_video = true;
                    document.getElementById('intro').play();
                    document.getElementById('intro').addEventListener('ended',function(){
                        show_video = false;
                        countdownTimer.init($data);
                        show_names = true;
                        const images = document.querySelectorAll('#image-holder img');
                        images.forEach((image) => {
                            image.classList.remove('opacity-0');
                            document.getElementById('code-input').value = '';
                        });
                    });
                  document.getElementById('code-input').focus();
                  setTimeout(function() {
                    document.getElementById('code-input').value='';
                  }, 100);
              
                  // Remove the event listener after it has been executed
                  document.removeEventListener('keydown', handleKeyDown);
                }
              });
              "
        >
            <div
                class="absolute w-1/6 text-center rounded-lg left-0 right-0 mx-auto timer"
            >
                <h1
                    class="m-10 text-6xl text-white"
                    x-text="countdownTimer.time().minutes+':'+countdownTimer.time().seconds"
                ></h1>
            </div>
            <div x-data="{ code: '' }" class=" ">
                <form
                    x-data
                    @submit.prevent="submitHandler(countdownTimer, code, $data)"
                >
                    <input
                        autocomplete="off"
                        id="code-input"
                        x-model="code"
                        maxlength="4"
                        type="text"
                        class="border-2 px-4 py-2 w-1/6 top-40 absolute left-0 right-0 mx-auto border bg-black text-white border-gray-300 rounded-md"
                        placeholder="Enter Code"
                    />
                </form>
            </div>
            <div
                class="fixed top-1/4 left-1/2 -translate-x-1/2 border-4 text-white border-[#2be2f6] bg-black p-10 z-50 font-bold text-3xl"
                x-show="!show_names && before_start">
                Press the red button to start.<br>You have 10:00 minutes to find all the codes!
            </div>
            <!-- The message that is shown after starting the game, instructing players to order an item on the laptop. -->
            <div
                id="video_intro" 
                class="fixed top-1/4 left-1/2 -translate-x-1/2 border-4 text-white border-[#2be2f6] bg-black p-10 z-50 font-bold text-3xl"
                x-show="show_video">
                    <video id="intro" src="assets/videos/intro.mp4">                    
                    </video>
            </div>
            <!-- The first puzzle, asking for the name of Fatiha -->
            <div
                id="names"
                class="fixed top-1/4 left-1/2 -translate-x-1/2 border-4 text-white border-[#2be2f6] bg-black p-10 z-50 font-bold text-3xl"
                x-show="show_names && correct_answers == 0">
                What is my name again?<br><br>
                Fatiha - 3956<br>
                Sarah - 4432<br>
                Basmah - 9080<br>
                Joud - 1322
            </div>
            <!-- A message from Fatiha, explaining the importance of a strong password. -->
            <div
                id="password"
                class="fixed top-1/4 left-1/2 -translate-x-1/2 border-4 text-white border-[#2be2f6] bg-black p-10 z-50 font-bold text-3xl"
                x-show="correct_answers == 1">                
                A strong password is very important, <br>
                find the strongest password to continue!
            </div>
            <!-- A message from Fatiha, complimenting you on finding the correct password. She says that you can protect her with tokens. -->
            <div
                id="compliment"
                class="fixed top-1/4 left-1/2 -translate-x-1/2 border-4 text-white border-[#2be2f6] bg-black p-10 z-50 font-bold text-3xl"
                x-show="correct_answers == 2">                
                Great job! You found the strongest password! <br>
                You can protect me with tokens now!
            </div>
            <!-- A message from Fatiha, complimenting you on finding the correct password. She says that you can protect her with tokens. -->
            <div
                id="compliment_2"
                class="fixed top-1/4 left-1/2 -translate-x-1/2 border-4 text-white border-[#2be2f6] bg-black p-10 z-50 font-bold text-3xl"
                x-show="correct_answers == 3">                
                Our protection keeps getting stronger! <br>
                Now we have to find the perpetrator!
            </div>
            <!-- The message that is shown after 4 correct answers. -->
            <div
                class="fixed top-1/4 left-1/2 -translate-x-1/2 border-4 text-white border-[#2be2f6] bg-black p-10 z-50 font-bold text-3xl"
                x-show="open_code_message && correct_answers == 4">
                Discover the pattern and find the code <br>
                First: enter the code on the panel, then: enter the code here!
            </div>
            <div
                class="fixed top-1/4 left-1/2 -translate-x-1/2 border-4 text-white border-[#2be2f6] bg-black p-10 z-50 font-bold text-3xl"
                x-show="correct_answers == 5">
                Amazing job! <br>
                You have succesfully protected me!
            </div>
            <span class="absolute left-[465px] top-[144px] text-4xl text-white" x-show="image_1"> 3956</span> 
            <span class="absolute left-[465px] bottom-[65px] text-4xl text-white" x-show="image_2"> 2584</span> 
            <span class="absolute right-[465px] top-[144px] text-4xl text-white" x-show="image_3"> 7424</span> 
            <span class="absolute right-[465px] bottom-[65px] text-4xl text-white" x-show="image_4"> 1833</span> 
        </div>
        <div id="image-holder">
                <img
                    class="opacity-0"
                    x-data
                    :src="$store.images.image_1"
                    alt="1"
                    id="img-1"
                />
                <img
                    class="opacity-0"
                    x-data
                    :src="$store.images.image_2"
                    alt="2"
                    id="img-2"
                />
                <img
                    class="opacity-0"
                    x-data
                    :src="$store.images.image_3"
                    alt="3"
                    id="img-3"
                />
                <img
                    class="opacity-0"
                    x-data
                    :src="$store.images.image_4"
                    alt="4"
                    id="img-4"
                />
            </div>

        <!-- A background image -->
        <!-- A button that says "Press enter to start" -->
        <script>
            function timer(expiry) {
                return {
                    expired: false, // Whether the timer has expired
                    expiry: expiry,
                    remaining: null,
                    init(data) {                        
                        this.setRemaining()
                        setInterval(() => {
                            this.setRemaining(data)
                        }, 1000)
                    },
                    setRemaining(data) {
                        if (this.expired) {
                            return
                        }
                        const diff = this.expiry - new Date().getTime()
                        // If there are 30 seconds left, loop the heartbeat.mp3 sound for 30 seconds. Check if the audio variable exists.
                        if (diff <= 30000 && diff > 0 && !window.audio) {
                            const audio = new Audio(urls.heartbeat);
                            audio.loop = true;
                            audio.play();
                            // Make the audio a global variable so it can be paused when the timer expires.
                            window.audio = audio;
                        }                                    
                        // If the timer has expired, set the remaining time to 0, otherwise set it to the difference.
                        if (diff <= 0) {
                            window.audio.pause();
                            this.expired = true;
                            data.time_expired = true;
                            this.remaining = 0
                        } else if (diff > 0) {
                            this.remaining = parseInt(diff / 1000)
                        }
                    },
                    days() {
                        return {
                            value: this.remaining / 86400,
                            remaining: this.remaining % 86400,
                        }
                    },
                    hours() {
                        return {
                            value: this.days().remaining / 3600,
                            remaining: this.days().remaining % 3600,
                        }
                    },
                    minutes() {
                        return {
                            value: this.hours().remaining / 60,
                            remaining: this.hours().remaining % 60,
                        }
                    },
                    seconds() {
                        return {
                            value: this.minutes().remaining,
                        }
                    },
                    format(value) {
                        return ('0' + parseInt(value)).slice(-2)
                    },
                    time() {
                        return {
                            expired: this.expired,
                            days: this.format(this.days().value),
                            hours: this.format(this.hours().value),
                            minutes: this.format(this.minutes().value),
                            seconds: this.format(this.seconds().value),
                        }
                    },
                }
            }

            function submitHandler(countdownTimer, code, data) {
                if (countdownTimer.expired && code !== '/**/') {
                    return
                }
                function updateImage(code, url, data) {
                    if (data['image_' + code]) {
                        return
                    }
                    // In the data variable, we can find a variable for each image. 
                    Alpine.store('images')['image_' + code] = url
                    data.correct_answers += 1;
                    data['image_' + code] = true;
                    if (data.correct_answers === 4) {                        
                        data.open_code_message = true;                       
                    }
                }
                // When the form is submitted, verify the code. There are four correct codes corresponding to certain images. If the code is correct, we use the global Alpine $store to update the image.
                if (code === '3956') {
                    const audio = new Audio(urls.success);
                    audio.play();
                    updateImage(1, urls.image_1, data);
                    document.getElementById('code-input').value = '';                    
                } else if (code === '2584') {
                    const audio = new Audio(urls.success);
                    audio.play();
                    updateImage(2, urls.image_2, data);
                    document.getElementById('code-input').value = '';
                } else if (code === '7424') {
                    const audio = new Audio(urls.success);
                    audio.play();
                    updateImage(3, urls.image_3, data);
                    document.getElementById('code-input').value = '';
                } else if (code === '1833') {
                    const audio = new Audio(urls.success);
                    audio.play();
                    updateImage(4, urls.image_4, data);
                    document.getElementById('code-input').value = '';
                } else if (code == '9841') {    
                    data.correct_answers += 1;                
                    const success = new Audio(urls.success);
                    success.play();
                    countdownTimer.expired = true;
                    document.getElementById('code-input').value = '';
                    if (window.audio){
                        window.audio.pause();
                    }
                } else if(code == '/**/'){
                    // Refresh the page.
                    location.reload();
                }                
                 else {
                    // Play the error sound from the urls variable.
                    const audio = new Audio(urls.error);
                    audio.play();
                    // If the code is incorrect we subtract 10 seconds from the timer.
                    document.getElementById('code-input').value = '';
                }
            }
        </script>
    </body>
</html>
