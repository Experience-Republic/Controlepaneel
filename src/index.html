<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="index.css" />
        <script defer type="module" src="index.js"></script>
        <!-- Import the urls from the index.js module -->
        <script type="module">
            import { urls } from './urls.js'
            // Make them globally available.
            window.urls = urls            
        </script>
    </head>
    <body>
        <div
            x-data="{ image_1:false, image_2:false, image_3:false, image_4:false, open: false, countdownTimer : timer(new Date().setSeconds(new Date().getSeconds() + 630)), correct_answers: 0, open_video: false, time_expired: false, open_code_message: false }"
            x-init="countdownTimer.init($data);"
        >
            <div
                class="bg-indigo-500 w-1/6 text-center rounded-lg mx-auto timer"
            >
                <h1
                    class="m-10 text-6xl text-white"
                    x-text="countdownTimer.time().minutes+':'+countdownTimer.time().seconds"
                ></h1>
            </div>
            <div x-data="{ code: '' }" class="flex items-center justify-center">
                <form
                    x-data
                    @submit.prevent="submitHandler(countdownTimer, code, $data)"
                >
                    <input
                        x-model="code"
                        maxlength="4"
                        type="text"
                        class="border-2 px-4 py-2 border border-gray-300 rounded-md"
                        placeholder="Enter Code"
                    />
                </form>
            </div>
            <!-- The alert that warns if a time penalty has been awarded after a wrong answer. -->
            <div
                class="fixed top-1/4 left-1/2 -translate-x-1/2 border-4 border-indigo-600 rounded-md bg-white p-10 z-50 font-bold text-3xl"
                x-show="open"
            >
                -10 Seconds!
            </div>
            <!-- The message that is shown before starting the game, instructing players to order an item on the laptop. -->
            <div
                class="fixed top-1/4 left-1/2 -translate-x-1/2 border-4 border-indigo-600 rounded-md bg-white p-10 z-50 font-bold text-3xl"
                x-show="!open && !open_video && !time_expired && !open_code_message">
                Place an order in the webshop!
            </div>
            <!-- The message that is shown after 4 correct answers. -->
            <div
                class="fixed top-1/4 left-1/2 -translate-x-1/2 border-4 border-indigo-600 rounded-md bg-white p-10 z-50 font-bold text-3xl"
                x-show="open_code_message">
                Open the wallbox with code: 1234
            </div>            
            <video
                class="fixed top-16 left-1/2 w-3/4 -translate-x-1/2 rounded-md p-10 z-50"
                x-show="open_video"
                controls
                autoplay
                src="assets/videos/All Correct.mp4"
            ></video>
            <video
                class="fixed top-16 left-1/2 w-3/4 -translate-x-1/2 rounded-md p-10 z-50"
                x-show="time_expired"
                controls
                autoplay
                src="assets/videos/Timer Expired.mp4"
        ></video>
        </div>
        <div class="flex flex-row">
            <div class="flex flex-col items-center w-1/2">
                <img
                    x-data
                    :src="$store.images.image_1"
                    alt="1"
                    class="m-2 w-1/4"
                />
                <img
                    x-data
                    :src="$store.images.image_2"
                    alt="2"
                    class="m-2 w-1/4"
                />
            </div>
            <div class="flex flex-col items-center w-1/2">
                <img
                    x-data
                    :src="$store.images.image_3"
                    alt="3"
                    class="m-2 w-1/4"
                />
                <img
                    x-data
                    :src="$store.images.image_4"
                    alt="4"
                    class="m-2 w-1/4"
                />
            </div>
        </div>

        <!-- A background image -->
        <!-- A button that says "Press enter to start" -->
        <script>
            function timer(expiry) {
                return {
                    expired: false, // Whether the timer has expired
                    expiry: expiry,
                    remaining: null,
                    init(data) {
                        this.setRemaining()
                        setInterval(() => {
                            this.setRemaining(data)
                        }, 1000)
                    },
                    setRemaining(data) {
                        if (this.expired) {
                            return
                        }
                        const diff = this.expiry - new Date().getTime()
                        // If the timer has expired, set the remaining time to 0, otherwise set it to the difference.
                        if (diff <= 0) {
                            this.expired = true;
                            data.time_expired = true;
                            this.remaining = 0
                        } else if (diff > 0) {
                            this.remaining = parseInt(diff / 1000)
                        }
                    },
                    days() {
                        return {
                            value: this.remaining / 86400,
                            remaining: this.remaining % 86400,
                        }
                    },
                    hours() {
                        return {
                            value: this.days().remaining / 3600,
                            remaining: this.days().remaining % 3600,
                        }
                    },
                    minutes() {
                        return {
                            value: this.hours().remaining / 60,
                            remaining: this.hours().remaining % 60,
                        }
                    },
                    seconds() {
                        return {
                            value: this.minutes().remaining,
                        }
                    },
                    format(value) {
                        return ('0' + parseInt(value)).slice(-2)
                    },
                    time() {
                        return {
                            expired: this.expired,
                            days: this.format(this.days().value),
                            hours: this.format(this.hours().value),
                            minutes: this.format(this.minutes().value),
                            seconds: this.format(this.seconds().value),
                        }
                    },
                }
            }

            function submitHandler(countdownTimer, code, data) {
                if (countdownTimer.expired) {
                    return
                }
                function updateImage(code, url, data) {
                    if (data['image_' + code]) {
                        return
                    }
                    // In the data variable, we can find a variable for each image. 
                    Alpine.store('images')['image_' + code] = url
                    data.correct_answers += 1;
                    data['image_' + code] = true;
                    if (data.correct_answers === 4) {
                        // Stop the timer.
                        countdownTimer.expired = true;
                        data.open_code_message = true;
                        // After 10 seconds, we display the instructions for opening the wallbox for 10 seconds, and afterwards show a video.
                        setTimeout(() => {                            
                            data.open_code_message = false;
                            data.open_video = true;
                        }, 10000)
                    }
                }
                // When the form is submitted, verify the code. There are four correct codes corresponding to certain images. If the code is correct, we use the global Alpine $store to update the image.
                if (code === '0001') {
                    updateImage(1, urls.image_1, data)
                } else if (code === '0002') {
                    updateImage(2, urls.image_2, data)
                } else if (code === '0003') {
                    updateImage(3, urls.image_3, data)
                } else if (code === '0004') {
                    updateImage(4, urls.image_4, data)
                } else {
                    // If the code is incorrect we subtract 10 seconds from the timer.
                    countdownTimer.expiry = countdownTimer.expiry - 10000
                    data.open = true
                    // Hide the popup after 2 seconds.
                    setTimeout(() => {
                        data.open = false
                    }, 2000)
                }
                return countdownTimer
            }
        </script>
    </body>
</html>
